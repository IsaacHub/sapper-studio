<div ref:container>
	<webview src="../pages/editor/index.html" nodeintegration></webview>
</div>

<style>
	ref:container {
		width: 100%;
		height: 100%;
		background-color: rgb(30,30,30);
	}
</style>

<script>
	import * as path from 'path';

	export default {
		oncreate() {
			this.on('destroy', () => {
				this.destroyed = true;
			});

			this.webview = this.refs.container.querySelector('webview');

			// this.webview = document.createElement('webview');
			// this.webview.nodeintegration = true;
			// this.webview.src = `file://${path.resolve(__dirname, '../pages/editor/index.html')}`;

			// console.log(this.refs);

			this.webview.addEventListener('dom-ready', () => {
				if (this.destroyed) return;

				const { selectedFile } = this.store.get();
				console.log({ selectedFile });
				if (selectedFile) this.load(selectedFile);
			});

			// TODO also activate on click
			this.store.set({
				lastSelectedEditor: this
			});
		},

		helpers: {
			uriFromPath(_path) {
				let pathName = path.resolve(_path).replace(/\\/g, '/');
				if (pathName.length > 0 && pathName.charAt(0) !== '/') {
					pathName = '/' + pathName;
				}
				return encodeURI('file://' + pathName);
			}
		},

		methods: {
			load(file) {
				this.webview.send('file', file);

				const { dir } = this.store.get();
				const relative = path.relative(dir, file);

				this.set({ status: '' }); // TODO binding bug
				this.set({ status: relative });
			},

			focus() {
				this.store.set({
					lastSelectedEditor: this
				});
			}
		}
	};
</script>